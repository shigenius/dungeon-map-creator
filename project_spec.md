# 3DダンジョンRPGマッピングツール仕様書

## 1. 概要

### 1.1 プロダクト概要
本ツールは、3DダンジョンRPG開発者向けの汎用的なマップエディタです。ブラウザ上で動作し、直感的な操作でダンジョンマップを作成・編集・管理できます。

### 1.2 主要機能
- グリッドベースのマップエディタ
- リアルタイム3Dプレビュー
- イベント配置・編集機能
- インポート/エクスポート機能（JSON形式）
- マップ検証機能
- テンプレート管理


## 2. システム要件

### 2.2 技術スタック
- **フロントエンド**
  - フレームワーク: React 18+
  - 状態管理: Redux Toolkit
  - 3D描画: Three.js
  - UIコンポーネント: Material-UI
  - ビルドツール: Vite
- **データ形式**: JSON
- **バリデーション**: JSON Schema Draft 7

## 3. 機能仕様

### 3.1 プロジェクト管理

#### 3.1.1 新規作成
- ダンジョン名、作成者情報の入力
- 初期フロアサイズの設定（5×5〜100×100）
- テンプレート選択オプション

#### 3.1.2 保存/読み込み
- JSONファイルのインポート/エクスポート

#### 3.1.3 バージョン管理
- 編集履歴の保存（最大50件）
- 変更内容の差分表示
- 任意のバージョンへのロールバック

### 3.2 マップエディタ

#### 3.2.1 基本編集機能
- **描画ツール**
  - ペンツール（1マス単位）
  - 矩形選択ツール
  - 塗りつぶしツール
  - スポイトツール
- **編集操作**
  - コピー/カット/ペースト
  - 元に戻す/やり直し（Ctrl+Z/Ctrl+Y）
  - グリッドスナップのON/OFF
- **表示オプション**
  - ズームイン/アウト（10%〜400%）
  - グリッド表示切替
  - 座標表示
  - ミニマップ

#### 3.2.2 レイヤー管理
- 床レイヤー
- 壁レイヤー
- イベントレイヤー
- 装飾レイヤー
- 各レイヤーの表示/非表示切替

### 3.3 マップ要素

#### 3.3.1 床タイプ
| タイプ | 説明 | 設定可能項目 |
|--------|------|--------------|
| 通常床 | 標準的な床 | テクスチャ、通行可否 |
| ダメージ床 | 歩くとダメージ | ダメージ量、ダメージタイプ |
| 滑る床 | 止まるまで直進 | 滑り方向 |
| 落とし穴 | 下階層へ落下 | 落下先座標、ダメージ有無、ダメージ値 |
| 一方通行床 | 特定方向のみ通行可 | 通行可能方向 |
| スイッチ床 | 踏むとイベント発動 | トリガーイベントID |
| ワープ床 | 即座に転送 | 転送先座標 |
| 回転床 | プレイヤーの向きを変更 | 回転方向、回転角度 |

#### 3.3.2 壁タイプ
| タイプ | 説明 | 設定可能項目 |
|--------|------|--------------|
| 通常壁 | 標準的な壁 | テクスチャ、透過性 |
| 扉 | 開閉可能 | 開閉アニメーション、自動開閉 |
| 鍵付き扉 | 特定の鍵が必要 | 必要鍵ID、解錠後の挙動 |
| 隠し扉 | 条件で出現 | 出現条件、発見ヒント |
| 破壊可能壁 | 攻撃で破壊可能 | 耐久値、破壊エフェクト |
| 片面壁 | 一方向のみ通行可 | 通行可能方向 |
| 透明壁 | 見えないが通行不可 | 当たり判定のみ |
| イベント壁 | 調べるとイベント | イベント内容 |

#### 3.3.3 環境設定
- **照明**
  - 環境光の強度（0.0〜1.0）
  - 各セルの明度設定
  - 光源オブジェクトの配置
- **天井**
  - 高さ設定（1〜10）
  - テクスチャ設定
- **BGM/環境音**
  - エリアごとのBGM設定
  - 環境効果音の設定

### 3.4 イベントシステム

#### 3.4.1 イベントタイプ
- **宝箱**: アイテム取得、1回のみ開封可能
- **NPC**: 会話、クエスト付与、ショップ
- **階段**: 階層間移動（上り/下り）
- **シンボルエンカウント**: 視認可能な敵
- **セーブポイント**: ゲーム内セーブ
- **回復ポイント**: HP/MP全回復
- **スイッチ**: 他のイベントを制御
- **看板**: テキスト表示
- **採取ポイント**: アイテム採取（時間で復活）
- **任意のカスタムイベント**

#### 3.4.2 トリガー条件
| トリガー | 説明 | 設定項目 |
|----------|------|----------|
| 自動実行 | プレイヤーが範囲内で自動発火 | 実行範囲、実行間隔 |
| 調べる | 決定ボタンで発火 | 向きの制限 |
| 接触 | プレイヤーが触れると発火 | 接触方向 |
| アイテム使用 | 特定アイテム使用で発火 | 必要アイテムID |
| 踏む | その場所を踏むと発火 | - |
| 時間経過 | 一定時間で発火 | 待機時間 |
| フラグ | 特定条件達成で発火 | 必要フラグ |
| ランダム | 確率で発火 | 発火確率 |

#### 3.4.3 アクション定義
```json
{
  "actions": [
    {
      "type": "show_message",
      "params": {
        "text": "表示するメッセージ",
        "speaker": "話者名",
        "portrait": "portrait_01"
      }
    },
    {
      "type": "give_item",
      "params": {
        "item_id": "potion_01",
        "quantity": 3
      }
    },
    {
      "type": "conditional_branch",
      "params": {
        "condition": {
          "type": "has_item",
          "item_id": "key_01"
        },
        "true_actions": [...],
        "false_actions": [...]
      }
    }
  ]
}
```

### 3.5 3Dプレビュー機能

#### 3.5.1 表示モード
- **編集モード**: 俯瞰視点でマップ全体を確認
- **プレイヤー視点**: 実際のゲーム画面を再現
- **ウォークスルー**: WASDキーで自由移動

#### 3.5.2 表示設定
- テクスチャ品質（低/中/高）
- 影の表示ON/OFF
- エフェクト表示
- 視野角調整（60°〜120°）

### 3.6 検証機能

#### 3.6.1 構造チェック
- 到達不可能エリアの検出
- 行き止まりの警告
- 必須通過ポイントの確認
- ループ構造の可視化

#### 3.6.2 バランスチェック
- 宝箱の配置密度
- 敵の配置バランス
- セーブポイント間の距離
- 想定プレイ時間の算出

#### 3.6.3 エラー検出
- 無効な参照の検出
- イベントループの警告
- リソース不足の通知

### 3.7 テンプレート機能

#### 3.7.1 部屋テンプレート
- 基本的な部屋構造の保存
- カテゴリ分類（通路、大部屋、特殊部屋）
- サムネイル付きリスト表示
- ドラッグ&ドロップで配置

#### 3.7.2 イベントテンプレート
- よく使うイベントの定型化
- パラメータのカスタマイズ
- プリセット管理

### 3.8 エクスポート機能

#### 3.8.1 出力形式
- **JSON形式**: 完全なマップデータ
- **画像形式**: マップの俯瞰図（PNG）
- **ドキュメント**: マップ仕様書（Markdown）

#### 3.8.2 最適化オプション
- 未使用リソースの除外
- データ圧縮
- 座標データの正規化

## 4. データ構造仕様

### 4.1 ルートオブジェクト
```json
{
  "version": "1.0.0",
  "dungeon": {},
  "resources": {},
  "metadata": {}
}
```

### 4.2 セル構造
```json
{
  "x": 0,
  "y": 0,
  "floor": {},
  "walls": {
    "north": {},
    "east": {},
    "south": {},
    "west": {}
  },
  "events": [],
  "decorations": [],
  "properties": {}
}
```

### 4.3 イベント構造
```json
{
  "id": "unique_id",
  "type": "event_type",
  "name": "イベント名",
  "position": {},
  "appearance": {},
  "trigger": {},
  "actions": [],
  "flags": {},
  "enabled": true
}
```

## 5. UI/UX設計

### 5.1 画面構成
- **メニューバー**: ファイル操作、編集、表示、ツール、ヘルプ
- **ツールバー**: よく使うツールへのクイックアクセス
- **サイドパネル（左）**: レイヤー、オブジェクトリスト
- **メインキャンバス**: マップ編集エリア
- **サイドパネル（右）**: プロパティ編集、テンプレート
- **ボトムパネル**: 座標表示、ズーム、検証結果

### 5.2 ショートカットキー
| キー | 機能 |
|------|------|
| Ctrl+S | 保存 |
| Ctrl+Z | 元に戻す |
| Ctrl+Y | やり直し |
| Ctrl+C/V | コピー/ペースト |
| Space | ハンドツール |
| 1-9 | ツール切替 |
| F5 | プレビュー |
| Tab | 3D表示切替 |

### 5.3 操作フロー
1. 新規プロジェクト作成
2. 基本的な床配置
3. 壁の設置
4. イベント配置
5. 検証実行
6. 3Dプレビュー確認
7. エクスポート

## 6. パフォーマンス要件


### 6.2 制限事項
- 最大マップサイズ: 100×100×10階層
- 最大イベント数: 1階層あたり1000個
- 最大ファイルサイズ: 50MB
- 同時編集可能階層数: 1

## 9. 用語集

| 用語 | 説明 |
|------|------|
| セル | マップの1マス単位 |
| フロア | ダンジョンの1階層 |
| トリガー | イベント発火条件 |
| アクション | イベント実行内容 |
| テンプレート | 再利用可能な部品 |

## 10. 参考資料
- 既存3DダンジョンRPG（世界樹の迷宮、Wizardry等）
- RPGツクールのイベントシステム
- Tiledマップエディタ
- Unity/Unreal Engineのレベルエディタ